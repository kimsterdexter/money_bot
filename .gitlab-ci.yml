stages:
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

# Ð¢ÐµÑÑ‚Ñ‹ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐµÑÐ»Ð¸ Ð½Ðµ Ð½ÑƒÐ¶Ð½Ñ‹)
test:
  stage: test
  image: python:3.12-slim
  before_script:
    - apt-get update && apt-get install -y gcc python3-dev
    - pip install -r backend/requirements.txt
  script:
    - echo "Running tests..."
    # Ð Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐ¹ ÐµÑÐ»Ð¸ Ñ…Ð¾Ñ‡ÐµÑˆÑŒ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ñ‹
    # - pytest tests/ -v
  only:
    - main
    - merge_requests
  tags:
    - docker

# Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° production
deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "Deploying to production server..."
    - |
      ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << 'ENDSSH'
        set -e
        cd /opt/money_bot || exit 1
        
        echo "ðŸ“¥ Pulling latest code..."
        git pull origin main
        
        echo "ðŸ”§ Creating .env file..."
        cat > .env << EOF
      BOT_TOKEN=${BOT_TOKEN}
      DB_HOST=postgres
      DB_PORT=5432
      DB_NAME=${DB_NAME}
      DB_USER=${DB_USER}
      DB_PASSWORD=${DB_PASSWORD}
      DAILY_INCOME_TIME=${DAILY_INCOME_TIME}
      DAILY_EXPENSE_TIME=${DAILY_EXPENSE_TIME}
      TIMEZONE=${TIMEZONE}
      EOF
        
        echo "ðŸ³ Deploying with Docker Compose..."
        docker-compose down
        docker-compose up -d --build
        
        echo "â³ Waiting for services to start..."
        sleep 10
        
        echo "âœ… Checking status..."
        docker-compose ps
        
        echo "ðŸ“Š Bot logs:"
        docker-compose logs --tail=20 bot
        
        echo "ðŸŽ‰ Deployment complete!"
      ENDSSH
  only:
    - main
  when: manual
  tags:
    - shell
  environment:
    name: production
    url: https://t.me/kostyatracker_bot

